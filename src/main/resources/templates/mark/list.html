<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head>
    <title>Notaneitor</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
          crossorigin="anonymous">

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<body>

<nav th:replace="~{fragments/nav :: nav}"></nav>

<div class="container mt-4" id="main-container">
    <h2>Notas</h2>
    <form class="form-inline mb-3" action="/mark/list" method="get">
        <div class="form-group mr-2">
            <input name="searchText" type="text" class="form-control" size="50"
                   th:value="${searchText}"
                   placeholder="Buscar por descripcion o nombre del alumno">
        </div>
        <input type="hidden" name="size"
               th:value="${param.size != null and !#lists.isEmpty(param.size) ? param.size[0] : null}"/>
        <button type="submit" class="btn btn-primary">Buscar</button>
    </form>
    <p>Las notas que actualmente figuran en el sistema son las siguientes:</p>
    <button id="updateButton" type="button" class="btn btn-primary mb-3">Actualizar</button>

    <div id="marksTableContainer">
        <div class="table-responsive">
            <table class="table table-hover" th:fragment="marksTable" id="marksTable">
                <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Descripción</th>
                    <th>Puntuación</th>
                    <th colspan="3">Acciones</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="mark : ${marksList}">
                    <td th:text="${mark.id}">1</td>
                    <td th:text="${mark.description}">Ejercicio 1</td>
                    <td th:text="${mark.score}">10</td>
                    <td><a th:href="@{/mark/details/{id}(id=${mark.id})}">detalles</a></td>
                    <td>
                        <a sec:authorize="hasRole('PROFESSOR')"
                           th:href="@{/mark/edit/{id}(id=${mark.id})}">modificar</a>
                        <div sec:authorize="hasRole('STUDENT')">
                            <div th:if="${mark.resend}">
                                <button type="button"
                                        class="btn btn-sm btn-warning mt-1 js-noresend"
                                        th:attr="data-mark-id=${mark.id}"
                                        th:disabled="${mark.user == null or mark.user.dni != #authentication.name}">
                                    No reenviar
                                </button>
                            </div>
                            <div th:unless="${mark.resend}">
                                <button type="button"
                                        class="btn btn-sm btn-info mt-1 js-resend"
                                        th:attr="data-mark-id=${mark.id}"
                                        th:disabled="${mark.user == null or mark.user.dni != #authentication.name}">
                                    Reenviar
                                </button>
                            </div>
                        </div>
                    </td>
                    <td><a sec:authorize="hasRole('PROFESSOR')"
                           th:href="@{/mark/delete/{id}(id=${mark.id})}">eliminar</a></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div th:if="${#lists.isEmpty(marksList)}" class="alert alert-warning">
        No marks
    </div>

    <footer th:replace="~{fragments/pagination :: pagination}"></footer>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script th:inline="javascript">
    /*<![CDATA[*/
    function buildUpdateUrl() {
        let page = /*[[${param.page != null and !#lists.isEmpty(param.page) ? param.page[0] : null}]]*/ null;
        let size = /*[[${param.size != null and !#lists.isEmpty(param.size) ? param.size[0] : null}]]*/ null;
        let searchText = /*[[${searchText}]]*/ null;
        let urlUpdate = '/mark/list/update';
        let params = [];
        if (page != null) {
            params.push('page=' + encodeURIComponent(page));
        }
        if (size != null) {
            params.push('size=' + encodeURIComponent(size));
        }
        if (searchText != null && searchText !== '') {
            params.push('searchText=' + encodeURIComponent(searchText));
        }
        if (params.length > 0) {
            urlUpdate += '?' + params.join('&');
        }
        return urlUpdate;
    }

    $("#updateButton").click(function () {
        $("#marksTableContainer").load(buildUpdateUrl() + " #marksTable");
    });

    $(document).on("click", ".js-resend", function () {
        var markId = $(this).data("mark-id");
        $.get("/mark/" + markId + "/resend", function () {
            $("#marksTableContainer").load(buildUpdateUrl() + " #marksTable");
        });
    });

    $(document).on("click", ".js-noresend", function () {
        var markId = $(this).data("mark-id");
        $.get("/mark/" + markId + "/noresend", function () {
            $("#marksTableContainer").load(buildUpdateUrl() + " #marksTable");
        });
    });
    /*]]>*/
</script>

</body>
</html>
